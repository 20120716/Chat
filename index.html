<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Firebase Chat with Room Creator</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; line-height: 1.6; }
        .hidden { display: none; }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #f9f9f9; }
        #chat-box { border: 1px solid #ccc; height: 350px; overflow-y: scroll; margin-bottom: 10px; padding: 10px; background: white; }
        .room-item { border: 1px solid #eee; padding: 12px; margin: 8px 0; cursor: pointer; border-radius: 5px; background: white; display: flex; justify-content: space-between; align-items: center; }
        .room-item:hover { background: #eef2ff; border-color: #a5b4fc; }
        input[type="text"], input[type="password"] { padding: 8px; width: calc(100% - 20px); margin-bottom: 10px; }
        button { padding: 8px 15px; cursor: pointer; background: #4f46e5; color: white; border: none; border-radius: 4px; }
        button:hover { background: #4338ca; }
        .meta { font-size: 0.8em; color: #666; }
    </style>
</head>
<body>

    <h1>ã‚†ã‚‹ãƒãƒ£ãƒƒãƒˆ</h1>

    <div id="lobby">
        <div class="card">
            <h3>1. ã‚ãªãŸã®åå‰ã‚’æ±ºã‚ã‚‹</h3>
            <input type="text" id="nickname-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ...">
        </div>

        <div class="card">
            <h3>2. æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</h3>
            <input type="text" id="new-room-name" placeholder="ãƒ«ãƒ¼ãƒ å">
            <input type="password" id="new-room-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç©ºãªã‚‰éµãªã—ï¼‰">
            <button onclick="createRoom()">ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
        </div>

        <hr>
        <h3>ãƒ«ãƒ¼ãƒ ä¸€è¦§</h3>
        <div id="room-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="chat-room" class="hidden">
        <button onclick="leaveRoom()" style="background: #6b7280;">â† ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹</button>
        <h2 id="current-room-name"></h2>
        <div id="chat-box"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." required>
            <button>é€ä¿¡</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebaseè¨­å®šã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRoomId = null;
        let unsubscribeMessages = null;

        // --- A. ãƒ«ãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ ---
        window.createRoom = async () => {
            const name = document.getElementById('new-room-name').value;
            const password = document.getElementById('new-room-pass').value;

            if (!name) return alert("ãƒ«ãƒ¼ãƒ åã‚’å…¥ã‚Œã¦ã­ï¼");

            try {
                await addDoc(collection(db, "rooms"), {
                    name: name,
                    password: password || null,
                    createdAt: serverTimestamp()
                });
                document.getElementById('new-room-name').value = "";
                document.getElementById('new-room-pass').value = "";
                alert("ãƒ«ãƒ¼ãƒ ã‚’ä½œã£ãŸã‚ˆï¼");
            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼èµ·ããŸã‚: " + e.message);
            }
        };

        // --- B. ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º ---
        const roomListDiv = document.getElementById('room-list');
        onSnapshot(query(collection(db, "rooms"), orderBy("createdAt", "desc")), (snapshot) => {
            roomListDiv.innerHTML = "";
            snapshot.forEach(doc => {
                const room = doc.data();
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `
                    <span>${room.name}</span>
                    <span class="meta">${room.password ? 'ğŸ”’ è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' : 'ğŸ”“ å…¬é–‹'}</span>
                `;
                div.onclick = () => joinRoom(doc.id, room);
                roomListDiv.appendChild(div);
            });
        });

        // --- C. ãƒ«ãƒ¼ãƒ å…¥å®¤ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰åˆ¤å®šï¼‰ ---
        window.joinRoom = (id, room) => {
            const nickname = document.getElementById('nickname-input').value;
            if (!nickname) return alert("ã¾ãšã¯ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ã­ï¼");

            if (room.password) {
                const pass = prompt("åˆè¨€è‘‰ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’å…¥ã‚Œã¦ã­");
                if (pass !== room.password) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ã¿ãŸã„...");
            }

            currentRoomId = id;
            document.getElementById('current-room-name').innerText = "ãƒ«ãƒ¼ãƒ : " + room.name;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('chat-room').classList.remove('hidden');

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®å–å¾—
            const q = query(collection(db, `rooms/${id}/messages`), orderBy("createdAt", "asc"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML = "";
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const p = document.createElement('div');
                    p.style.marginBottom = "8px";
                    p.innerHTML = `<small>${m.sender}</small><br><strong>${m.text}</strong>`;
                    chatBox.appendChild(p);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        };

        // --- D. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ ---
        document.getElementById('message-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const nickname = document.getElementById('nickname-input').value;

            await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
                text: input.value,
                sender: nickname,
                createdAt: serverTimestamp()
            });
            input.value = "";
        };

        // --- ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ ---
        window.leaveRoom = () => {
            if (unsubscribeMessages) unsubscribeMessages();
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('chat-room').classList.add('hidden');
        };
    </script>
</body>
</html>
