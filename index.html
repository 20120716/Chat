<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Firebase Chat - Auto Delete Mode</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; line-height: 1.6; background: #f0f2f5; }
        .hidden { display: none; }
        .card { border: none; padding: 20px; margin-bottom: 15px; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #chat-box { border: 1px solid #eee; height: 350px; overflow-y: scroll; margin-bottom: 15px; padding: 15px; background: #fafafa; border-radius: 8px; }
        .room-item { border: 1px solid #eee; padding: 15px; margin: 8px 0; cursor: pointer; border-radius: 8px; background: white; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .room-item:hover { background: #e0e7ff; transform: translateY(-1px); }
        input[type="text"], input[type="password"] { padding: 10px; width: calc(100% - 22px); margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 10px 20px; cursor: pointer; background: #4f46e5; color: white; border: none; border-radius: 6px; font-weight: bold; }
        button:hover { background: #4338ca; }
        .meta { font-size: 0.8em; color: #666; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 6px; background: #fff; border-left: 4px solid #4f46e5; }
    </style>
</head>
<body>

    <h1>ã‚†ã‚‹ãƒãƒ£ãƒƒãƒˆ (è‡ªå‹•å‰Šé™¤ä»˜)</h1>

    <div id="lobby">
        <div class="card">
            <h3>1. ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </h3>
            <input type="text" id="nickname-input" placeholder="åå‰ã‚’æ±ºã‚ã¦ã­">
        </div>

        <div class="card">
            <h3>2. ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</h3>
            <input type="text" id="new-room-name" placeholder="ãƒ«ãƒ¼ãƒ å">
            <input type="password" id="new-room-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãªã—ãªã‚‰ç©ºæ¬„ï¼‰">
            <button onclick="createRoom()">ä½œæˆã—ã¦å…¥å®¤</button>
        </div>

        <hr>
        <h3>ãƒ«ãƒ¼ãƒ ä¸€è¦§</h3>
        <div id="room-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="chat-room" class="hidden">
        <div class="card">
            <button onclick="leaveRoom()" style="background: #6b7280;">â† é€€å‡ºã™ã‚‹</button>
            <h2 id="current-room-name"></h2>
            <div id="chat-box"></div>
            <form id="message-form" style="display: flex; gap: 5px;">
                <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." required style="margin-bottom:0; flex-grow:1;">
                <button>é€ä¿¡</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, getDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebaseè¨­å®šï¼ˆè‡ªåˆ†ã®ã‚„ã¤ã«æ›¸ãæ›ãˆã¦ï¼ï¼‰ ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRoomId = null;
        let unsubscribeMessages = null;

        // --- ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®ç›£è¦– ---
        onSnapshot(query(collection(db, "rooms"), orderBy("createdAt", "desc")), (snapshot) => {
            const roomListDiv = document.getElementById('room-list');
            roomListDiv.innerHTML = "";
            snapshot.forEach(docSnap => {
                const room = docSnap.data();
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `
                    <div>
                        <strong>${room.name}</strong><br>
                        <span class="meta">ä¸­ã«ã„ã‚‹äºº: ${room.activeUsers || 0}äºº</span>
                    </div>
                    <span class="meta">${room.password ? 'ğŸ”’' : 'ğŸ”“'}</span>
                `;
                div.onclick = () => joinRoom(docSnap.id, room);
                roomListDiv.appendChild(div);
            });
        });

        // --- ãƒ«ãƒ¼ãƒ ä½œæˆ ---
        window.createRoom = async () => {
            const name = document.getElementById('new-room-name').value;
            const password = document.getElementById('new-room-pass').value;
            const nickname = document.getElementById('nickname-input').value;

            if (!nickname) return alert("å…ˆã«åå‰ã‚’æ±ºã‚ã¦ã­ï¼");
            if (!name) return alert("ãƒ«ãƒ¼ãƒ åã‚’å…¥ã‚Œã¦ã­ï¼");

            const docRef = await addDoc(collection(db, "rooms"), {
                name: name,
                password: password || null,
                activeUsers: 0, // æœ€åˆã¯0
                createdAt: serverTimestamp()
            });

            // ãã®ã¾ã¾å…¥å®¤
            const snap = await getDoc(docRef);
            joinRoom(docRef.id, snap.data());
        };

        // --- å…¥å®¤å‡¦ç† ---
        window.joinRoom = async (id, room) => {
            const nickname = document.getElementById('nickname-input').value;
            if (!nickname) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");

            if (room.password) {
                const pass = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
                if (pass !== room.password) return alert("é•ã†ã‚ˆ");
            }

            currentRoomId = id;
            
            // äººæ•°ã‚’+1
            await updateDoc(doc(db, "rooms", id), { activeUsers: increment(1) });

            document.getElementById('current-room-name').innerText = room.name;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('chat-room').classList.remove('hidden');

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—
            const q = query(collection(db, `rooms/${id}/messages`), orderBy("createdAt", "asc"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML = "";
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const div = document.createElement('div');
                    div.className = 'msg';
                    div.innerHTML = `<small>${m.sender}</small><div>${m.text}</div>`;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        };

        // --- é€€å‡ºå‡¦ç†ï¼ˆ0äººãªã‚‰å‰Šé™¤ï¼‰ ---
        window.leaveRoom = async () => {
            if (!currentRoomId) return;

            const roomRef = doc(db, "rooms", currentRoomId);
            if (unsubscribeMessages) unsubscribeMessages();

            // äººæ•°ã‚’-1
            await updateDoc(roomRef, { activeUsers: increment(-1) });

            // 0äººã‹ãƒã‚§ãƒƒã‚¯
            const snap = await getDoc(roomRef);
            if (snap.exists() && snap.data().activeUsers <= 0) {
                await deleteDoc(roomRef);
                console.log("éƒ¨å±‹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
            }

            currentRoomId = null;
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('chat-room').classList.add('hidden');
        };

        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ ---
        document.getElementById('message-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const nickname = document.getElementById('nickname-input').value;
            await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
                text: input.value,
                sender: nickname,
                createdAt: serverTimestamp()
            });
            input.value = "";
        };

        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãŸã¨ãã‚‚é€€å‡ºå‡¦ç†ã‚’è©¦ã¿ã‚‹
        window.onbeforeunload = () => { if(currentRoomId) leaveRoom(); };

    </script>
</body>
</html>
