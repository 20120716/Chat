<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Firebase Chat - Fixed Version</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; line-height: 1.6; background: #f0f2f5; }
        .hidden { display: none; }
        .card { border: none; padding: 20px; margin-bottom: 15px; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #chat-box { border: 1px solid #eee; height: 350px; overflow-y: scroll; margin-bottom: 15px; padding: 15px; background: #fafafa; border-radius: 8px; }
        .room-item { border: 1px solid #eee; padding: 15px; margin: 8px 0; cursor: pointer; border-radius: 8px; background: white; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .room-item:hover { background: #e0e7ff; }
        input[type="text"], input[type="password"] { padding: 10px; width: calc(100% - 22px); margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 10px 20px; cursor: pointer; background: #4f46e5; color: white; border: none; border-radius: 6px; font-weight: bold; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 6px; background: #fff; border-left: 4px solid #4f46e5; }
    </style>
</head>
<body>

    <h1>ã‚†ã‚‹ãƒãƒ£ãƒƒãƒˆ</h1>

    <div id="lobby">
        <div class="card">
            <h3>1. ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </h3>
            <input type="text" id="nickname-input" placeholder="åå‰ã‚’æ±ºã‚ã¦ã­">
        </div>
        <div class="card">
            <h3>2. ãƒ«ãƒ¼ãƒ ã‚’ä½œã‚‹</h3>
            <input type="text" id="new-room-name" placeholder="ãƒ«ãƒ¼ãƒ å">
            <input type="password" id="new-room-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãªã—ãªã‚‰ç©ºæ¬„ï¼‰">
            <button onclick="createRoom()">ä½œæˆã—ã¦å…¥å®¤</button>
        </div>
        <hr>
        <h3>ãƒ«ãƒ¼ãƒ ä¸€è¦§</h3>
        <div id="room-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="chat-room" class="hidden">
        <div class="card">
            <button onclick="leaveRoom()" style="background: #6b7280;">â† é€€å‡ºã™ã‚‹</button>
            <h2 id="current-room-name"></h2>
            <div id="chat-box"></div>
            <form id="message-form" style="display: flex; gap: 5px;">
                <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." required style="flex-grow:1;">
                <button>é€ä¿¡</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, getDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA_NiCTmJwDA0nWNISNYaQXNuih6XRGQWE",
            authDomain: "othello-bae8a.firebaseapp.com",
            databaseURL: "https://othello-bae8a-default-rtdb.firebaseio.com",
            projectId: "othello-bae8a",
            storageBucket: "othello-bae8a.firebasestorage.app",
            messagingSenderId: "265645164943",
            appId: "1:265645164943:web:65b0b9ce73f927f1c723fa",
            measurementId: "G-6DY5N71MJ3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRoomId = null;
        let unsubscribeMessages = null;

        // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®ç›£è¦–
        onSnapshot(query(collection(db, "rooms"), orderBy("createdAt", "desc")), (snapshot) => {
            const roomListDiv = document.getElementById('room-list');
            roomListDiv.innerHTML = "";
            snapshot.forEach(docSnap => {
                const room = docSnap.data();
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `<div><strong>${room.name}</strong><br><small>äººæ•°: ${room.activeUsers || 0}</small></div><span>${room.password ? 'ğŸ”’' : 'ğŸ”“'}</span>`;
                div.onclick = () => joinRoom(docSnap.id);
                roomListDiv.appendChild(div);
            });
        });

        // ãƒ«ãƒ¼ãƒ ä½œæˆ
        window.createRoom = async () => {
            const name = document.getElementById('new-room-name').value;
            const password = document.getElementById('new-room-pass').value;
            const nickname = document.getElementById('nickname-input').value;

            if (!nickname || !name) return alert("åå‰ã¨ãƒ«ãƒ¼ãƒ åã‚’å…¥ã‚Œã¦ã­");

            const docRef = await addDoc(collection(db, "rooms"), {
                name: name,
                password: password || null,
                activeUsers: 0,
                createdAt: serverTimestamp()
            });
            joinRoom(docRef.id);
        };

        // å…¥å®¤å‡¦ç†ï¼ˆã“ã“ã§æœ€æ–°ã®roomãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ï¼‰
        window.joinRoom = async (id) => {
            const nickname = document.getElementById('nickname-input').value;
            if (!nickname) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼");

            const roomRef = doc(db, "rooms", id);
            const snap = await getDoc(roomRef);
            if (!snap.exists()) return alert("ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚‰ã¸ã‚“...");
            const room = snap.data();

            if (room.password) {
                const pass = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
                if (pass !== room.password) return alert("é•ã†ã‚ˆ");
            }

            currentRoomId = id;
            await updateDoc(roomRef, { activeUsers: increment(1) });

            document.getElementById('current-room-name').innerText = room.name;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('chat-room').classList.remove('hidden');

            const q = query(collection(db, `rooms/${id}/messages`), orderBy("createdAt", "asc"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML = "";
                snapshot.forEach(msgDoc => {
                    const m = msgDoc.data();
                    const div = document.createElement('div');
                    div.className = 'msg';
                    div.innerHTML = `<small>${m.sender}</small><div>${m.text}</div>`;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        };

        // é€€å‡ºå‡¦ç†
        window.leaveRoom = async () => {
            if (!currentRoomId) return;
            const roomRef = doc(db, "rooms", currentRoomId);
            if (unsubscribeMessages) unsubscribeMessages();

            await updateDoc(roomRef, { activeUsers: increment(-1) });
            const snap = await getDoc(roomRef);
            if (snap.exists() && snap.data().activeUsers <= 0) {
                await deleteDoc(roomRef);
            }

            currentRoomId = null;
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('chat-room').classList.add('hidden');
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        document.getElementById('message-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const nickname = document.getElementById('nickname-input').value;
            await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
                text: input.value,
                sender: nickname,
                createdAt: serverTimestamp()
            });
            input.value = "";
        };

        window.onbeforeunload = () => { if(currentRoomId) leaveRoom(); };
    </script>
</body>
</html>
