<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Firebase Simple Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
        .hidden { display: none; }
        #chat-box { border: 1px solid #ccc; height: 300px; overflow-y: scroll; margin-bottom: 10px; padding: 10px; }
        .room-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; cursor: pointer; border-radius: 5px; }
        .room-item:hover { background: #f0f0f0; }
    </style>
</head>
<body>

    <h1>çˆ†é€Ÿãƒãƒ£ãƒƒãƒˆ</h1>

    <div id="lobby">
        <input type="text" id="nickname-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›...">
        <hr>
        <h3>ãƒ«ãƒ¼ãƒ ä¸€è¦§</h3>
        <div id="room-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="chat-room" class="hidden">
        <button onclick="leaveRoom()">â† ãƒ­ãƒ“ãƒ¼ã¸æˆ»ã‚‹</button>
        <h2 id="current-room-name"></h2>
        <div id="chat-box"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." required>
            <button>é€ä¿¡</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ã“ã“ã«è‡ªåˆ†ã®Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ï¼
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentRoomId = null;
        let unsubscribeMessages = null;

        // --- ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾— ---
        const roomListDiv = document.getElementById('room-list');
        onSnapshot(query(collection(db, "rooms"), orderBy("createdAt", "desc")), (snapshot) => {
            roomListDiv.innerHTML = "";
            snapshot.forEach(doc => {
                const room = doc.data();
                const div = document.createElement('div');
                div.className = 'room-item';
                div.innerHTML = `${room.name} ${room.password ? 'ğŸ”’' : 'ğŸ”“'}`;
                div.onclick = () => joinRoom(doc.id, room);
                roomListDiv.appendChild(div);
            });
        });

        // --- ãƒ«ãƒ¼ãƒ å…¥å®¤ ---
        window.joinRoom = (id, room) => {
            const nickname = document.getElementById('nickname-input').value;
            if (!nickname) return alert("å…ˆã«ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ±ºã‚ã¦ã­ï¼");

            if (room.password) {
                const pass = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã­");
                if (pass !== room.password) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ã‚ˆ");
            }

            currentRoomId = id;
            document.getElementById('current-room-name').innerText = room.name;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('chat-room').classList.remove('hidden');

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›£è¦–é–‹å§‹
            const q = query(collection(db, `rooms/${id}/messages`), orderBy("createdAt", "asc"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML = "";
                snapshot.forEach(doc => {
                    const m = doc.data();
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${m.sender}:</strong> ${m.text}`;
                    chatBox.appendChild(p);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        };

        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ ---
        document.getElementById('message-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const nickname = document.getElementById('nickname-input').value;

            await addDoc(collection(db, `rooms/${currentRoomId}/messages`), {
                text: input.value,
                sender: nickname,
                createdAt: serverTimestamp()
            });
            input.value = "";
        };

        // --- ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹ ---
        window.leaveRoom = () => {
            if (unsubscribeMessages) unsubscribeMessages();
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('chat-room').classList.add('hidden');
        };
    </script>
</body>
</html>
